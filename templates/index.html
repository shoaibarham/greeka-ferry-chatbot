{% extends "base.html" %}

{% block title %}Ferry Chat - Greek Ferry Information System{% endblock %}

{% block content %}
<div class="row justify-content-center">
  <div class="col-md-8">
    <div class="card shadow">
      <div class="card-header bg-primary text-white">
        <h4 class="mb-0">Greek Ferry Information Assistant</h4>
      </div>
      <div class="card-body">
        <div id="chat-container" class="mb-4">
          <div id="messages" class="p-3 bg-light rounded" style="height: 400px; overflow-y: auto;">
            <div class="message system-message mb-3">
              <div class="message-content p-3 rounded">
                <p>Hello! I'm your Greek Ferry Information Assistant. I can help you with:</p>
                <ul>
                  <li>Ferry routes between Greek islands</li>
                  <li>Schedules and departure times</li>
                  <li>Price information and accommodations</li>
                  <li>Historical routes that were available in the past</li>
                </ul>
                <p>How can I assist you today?</p>
              </div>
            </div>
            <!-- Messages will be added here -->
          </div>
        </div>

        <!-- Query suggestions -->
        <div class="mb-3">
          <div class="d-flex flex-wrap gap-2">
            <button class="btn btn-sm btn-outline-primary query-suggestion">Ferries from Athens to Santorini</button>
            <button class="btn btn-sm btn-outline-primary query-suggestion">Best way to get to Mykonos</button>
            <button class="btn btn-sm btn-outline-primary query-suggestion">Ferry options from Crete to Rhodes</button>
            <button class="btn btn-sm btn-outline-primary query-suggestion">Historical routes from Brindisi to Corfu</button>
          </div>
        </div>

        <!-- Input form -->
        <form id="chat-form">
          <div class="input-group">
            <input 
              type="text" 
              id="user-input" 
              class="form-control" 
              placeholder="Type your question here..." 
              required
              autocomplete="off"
            >
            <button type="submit" class="btn btn-primary">
              <span id="send-text">Send</span>
              <div id="send-loading" class="spinner-border spinner-border-sm d-none" role="status">
                <span class="visually-hidden">Loading...</span>
              </div>
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
  const chatForm = document.getElementById('chat-form');
  const userInput = document.getElementById('user-input');
  const messagesContainer = document.getElementById('messages');
  const sendText = document.getElementById('send-text');
  const sendLoading = document.getElementById('send-loading');
  
  // Get query parameter if present
  const urlParams = new URLSearchParams(window.location.search);
  const queryParam = urlParams.get('query');
  
  // Set up query suggestions
  document.querySelectorAll('.query-suggestion').forEach(button => {
    button.addEventListener('click', function() {
      userInput.value = this.textContent;
      userInput.focus();
    });
  });
  
  // Auto-fill if query parameter is present
  if (queryParam === 'historical') {
    userInput.value = 'Tell me about historical routes that were available in the past';
  }
  
  // Function to add a message to the chat
  function addMessage(content, isUser = false, isError = false) {
    const messageDiv = document.createElement('div');
    messageDiv.className = `message ${isUser ? 'user-message' : 'agent-message'} mb-3`;
    
    const messageContent = document.createElement('div');
    messageContent.className = `message-content p-3 rounded ${isUser ? 'bg-primary text-white' : isError ? 'bg-danger text-white' : 'bg-light'}`;
    
    // If it's not an error, try to format the message with markdown-like syntax
    if (!isError) {
      // Format the content to handle some basic markdown-like syntax
      let formattedContent = content;
      
      // Process bullet points
      formattedContent = formattedContent.replace(/^- (.+)$/gm, '<li>$1</li>');
      if (formattedContent.includes('<li>')) {
        formattedContent = formattedContent.replace(/(<li>.+<\/li>)+/g, '<ul>$&</ul>');
      }
      
      // Process bold text
      formattedContent = formattedContent.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');
      
      // Process headings
      formattedContent = formattedContent.replace(/^### (.+)$/gm, '<h5>$1</h5>');
      formattedContent = formattedContent.replace(/^## (.+)$/gm, '<h4>$1</h4>');
      formattedContent = formattedContent.replace(/^# (.+)$/gm, '<h3>$1</h3>');
      
      // Split into paragraphs
      const paragraphs = formattedContent.split('\n\n');
      
      // Join paragraphs with proper HTML
      formattedContent = paragraphs.map(p => {
        if (p.startsWith('<ul>') || p.startsWith('<h')) {
          return p;
        }
        return `<p>${p}</p>`;
      }).join('');
      
      // Replace single line breaks with <br> tags within paragraphs
      formattedContent = formattedContent.replace(/<p>(.+?)\n(.+?)<\/p>/g, '<p>$1<br>$2</p>');
      
      messageContent.innerHTML = formattedContent;
    } else {
      messageContent.textContent = content;
    }
    
    messageDiv.appendChild(messageContent);
    messagesContainer.appendChild(messageDiv);
    
    // Scroll to bottom of messages
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
  }
  
  // Set up conversation ID for session tracking
  let conversationId = sessionStorage.getItem('conversationId');
  if (!conversationId) {
    conversationId = Date.now().toString();
    sessionStorage.setItem('conversationId', conversationId);
  }
  
  // Handle form submission
  chatForm.addEventListener('submit', function(e) {
    e.preventDefault();
    
    const message = userInput.value.trim();
    if (!message) return;
    
    // Add user message to chat
    addMessage(message, true);
    
    // Disable input and show loading
    userInput.disabled = true;
    sendText.classList.add('d-none');
    sendLoading.classList.remove('d-none');
    
    // Send message to backend
    fetch('/api/chat', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        message: message,
        conversation_id: conversationId
      })
    })
      .then(response => response.json())
      .then(data => {
        if (data.error) {
          addMessage(`Error: ${data.error}. ${data.details || ''}`, false, true);
        } else {
          addMessage(data.response);
          
          // Update conversation ID if provided
          if (data.conversation_id) {
            conversationId = data.conversation_id;
            sessionStorage.setItem('conversationId', conversationId);
          }
        }
      })
      .catch(error => {
        addMessage(`Failed to get response: ${error.message}`, false, true);
      })
      .finally(() => {
        // Re-enable input and hide loading
        userInput.disabled = false;
        userInput.value = '';
        userInput.focus();
        sendText.classList.remove('d-none');
        sendLoading.classList.add('d-none');
      });
  });
});
</script>

<style>
  .user-message {
    text-align: right;
  }
  
  .user-message .message-content {
    display: inline-block;
    max-width: 80%;
    border-radius: 1rem 1rem 0 1rem !important;
  }
  
  .agent-message .message-content,
  .system-message .message-content {
    display: inline-block;
    max-width: 80%;
    border-radius: 1rem 1rem 1rem 0 !important;
  }
  
  .message p:last-child {
    margin-bottom: 0;
  }
  
  .query-suggestion {
    transition: all 0.2s;
    cursor: pointer;
  }
  
  .query-suggestion:hover {
    transform: translateY(-2px);
  }
</style>
{% endblock %}