{% extends "base.html" %}

{% block title %}Admin Panel - Greek Ferry Information System{% endblock %}

{% block content %}
<div class="row">
  <div class="col-md-12">
    <div class="card shadow mb-4">
      <div class="card-header bg-danger text-white">
        <h4 class="mb-0">Admin Panel</h4>
      </div>
      <div class="card-body">
        <div class="row">
          <div class="col-md-6">
            <div class="card mb-4 bg-light">
              <div class="card-header">
                <h5 class="mb-0">Database Status</h5>
              </div>
              <div class="card-body">
                <div class="d-flex justify-content-between mb-3">
                  <div class="loader spinner-border spinner-border-sm text-primary" role="status" id="db-status-loader">
                    <span class="visually-hidden">Loading...</span>
                  </div>
                  <span id="db-status-badge" class="badge bg-secondary">Checking...</span>
                </div>
                <div id="database-info">
                  <p>Checking database status...</p>
                </div>
              </div>
            </div>
          </div>
          <div class="col-md-6">
            <div class="card mb-4">
              <div class="card-header">
                <h5 class="mb-0">Data Management</h5>
              </div>
              <div class="card-body">
                <p>Update data from external sources to ensure the most current information.</p>
                <div class="mb-3">
                  <button type="button" class="btn btn-primary" id="update-main-data-btn">
                    Update Ferry Data
                  </button>
                  <div class="spinner-border spinner-border-sm text-primary d-none" role="status" id="main-update-loader">
                    <span class="visually-hidden">Loading...</span>
                  </div>
                </div>
                <div class="mb-3">
                  <button type="button" class="btn btn-info" id="update-historical-data-btn">
                    Update Historical Data
                  </button>
                  <div class="spinner-border spinner-border-sm text-info d-none" role="status" id="historical-update-loader">
                    <span class="visually-hidden">Loading...</span>
                  </div>
                </div>
                <div class="alert alert-info d-none" id="update-result">
                  Update status will appear here.
                </div>
              </div>
            </div>
          </div>
        </div>
        
        <div class="row">
          <div class="col-md-12">
            <div class="card mb-4">
              <div class="card-header">
                <h5 class="mb-0">Agent Testing</h5>
              </div>
              <div class="card-body">
                <p>Test the ferry agent with specific queries to verify functionality.</p>
                <div class="mb-3">
                  <label for="test-query" class="form-label">Test Query</label>
                  <div class="input-group">
                    <input type="text" class="form-control" id="test-query" placeholder="Enter a test query...">
                    <button class="btn btn-primary" type="button" id="run-test-btn">Test</button>
                  </div>
                </div>
                <div class="mb-3">
                  <label for="test-result" class="form-label">Result</label>
                  <div class="card bg-light">
                    <div class="card-body">
                      <pre id="test-result" class="mb-0">Results will appear here...</pre>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
  // Check database status on page load
  checkDatabaseStatus();
  
  // Set up event listeners
  document.getElementById('update-main-data-btn').addEventListener('click', updateMainData);
  document.getElementById('update-historical-data-btn').addEventListener('click', updateHistoricalData);
  document.getElementById('run-test-btn').addEventListener('click', runTestQuery);
  
  // Function to check database status
  function checkDatabaseStatus() {
    const statusLoader = document.getElementById('db-status-loader');
    const statusBadge = document.getElementById('db-status-badge');
    const databaseInfo = document.getElementById('database-info');
    
    statusLoader.classList.remove('d-none');
    statusBadge.innerText = 'Checking...';
    statusBadge.className = 'badge bg-secondary';
    
    fetch('/api/database-status')
      .then(response => response.json())
      .then(data => {
        statusLoader.classList.add('d-none');
        
        if (data.status === 'online') {
          statusBadge.innerText = 'Online';
          statusBadge.className = 'badge bg-success';
          
          // Display database information
          let html = '<h6>Main Database</h6>';
          html += '<ul class="list-group mb-3">';
          for (const [table, count] of Object.entries(data.table_counts)) {
            html += `<li class="list-group-item d-flex justify-content-between align-items-center">
                      ${table}
                      <span class="badge bg-primary rounded-pill">${count}</span>
                    </li>`;
          }
          html += '</ul>';
          
          html += '<h6>Historical Database</h6>';
          html += '<ul class="list-group mb-3">';
          for (const [table, count] of Object.entries(data.historical_counts)) {
            html += `<li class="list-group-item d-flex justify-content-between align-items-center">
                      ${table}
                      <span class="badge bg-primary rounded-pill">${count}</span>
                    </li>`;
          }
          html += '</ul>';
          
          if (data.last_update) {
            html += `<p class="text-info">Last updated: ${data.last_update}</p>`;
          }
          
          databaseInfo.innerHTML = html;
        } else {
          statusBadge.innerText = 'Error';
          statusBadge.className = 'badge bg-danger';
          databaseInfo.innerHTML = `<div class="alert alert-danger">Error: ${data.error || 'Unknown error'}</div>`;
        }
      })
      .catch(error => {
        statusLoader.classList.add('d-none');
        statusBadge.innerText = 'Error';
        statusBadge.className = 'badge bg-danger';
        databaseInfo.innerHTML = `<div class="alert alert-danger">Failed to check database status: ${error.message}</div>`;
      });
  }
  
  // Function to update main ferry data
  function updateMainData() {
    const updateBtn = document.getElementById('update-main-data-btn');
    const loader = document.getElementById('main-update-loader');
    const resultAlert = document.getElementById('update-result');
    
    // Disable button and show loader
    updateBtn.disabled = true;
    loader.classList.remove('d-none');
    resultAlert.classList.add('d-none');
    
    fetch('/api/update_data', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({})
    })
      .then(response => response.json())
      .then(data => {
        updateBtn.disabled = false;
        loader.classList.add('d-none');
        resultAlert.classList.remove('d-none');
        
        if (data.success) {
          resultAlert.className = 'alert alert-success';
          resultAlert.innerText = `Success: ${data.message}`;
          
          // Refresh database status
          setTimeout(checkDatabaseStatus, 1000);
        } else {
          resultAlert.className = 'alert alert-danger';
          resultAlert.innerText = `Error: ${data.error || 'Unknown error'}`;
        }
      })
      .catch(error => {
        updateBtn.disabled = false;
        loader.classList.add('d-none');
        resultAlert.classList.remove('d-none');
        resultAlert.className = 'alert alert-danger';
        resultAlert.innerText = `Error: ${error.message}`;
      });
  }
  
  // Function to update historical ferry data
  function updateHistoricalData() {
    const updateBtn = document.getElementById('update-historical-data-btn');
    const loader = document.getElementById('historical-update-loader');
    const resultAlert = document.getElementById('update-result');
    
    // Disable button and show loader
    updateBtn.disabled = true;
    loader.classList.remove('d-none');
    resultAlert.classList.add('d-none');
    
    fetch('/api/update_historical_data', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({})
    })
      .then(response => response.json())
      .then(data => {
        updateBtn.disabled = false;
        loader.classList.add('d-none');
        resultAlert.classList.remove('d-none');
        
        if (data.success) {
          resultAlert.className = 'alert alert-success';
          resultAlert.innerText = `Success: ${data.message}`;
          
          // Refresh database status
          setTimeout(checkDatabaseStatus, 1000);
        } else {
          resultAlert.className = 'alert alert-danger';
          resultAlert.innerText = `Error: ${data.error || 'Unknown error'}`;
        }
      })
      .catch(error => {
        updateBtn.disabled = false;
        loader.classList.add('d-none');
        resultAlert.classList.remove('d-none');
        resultAlert.className = 'alert alert-danger';
        resultAlert.innerText = `Error: ${error.message}`;
      });
  }
  
  // Function to run a test query
  function runTestQuery() {
    const queryInput = document.getElementById('test-query');
    const testResult = document.getElementById('test-result');
    const runButton = document.getElementById('run-test-btn');
    
    const query = queryInput.value.trim();
    if (!query) {
      testResult.innerText = 'Please enter a query to test.';
      return;
    }
    
    // Disable button and show loading
    runButton.disabled = true;
    testResult.innerText = 'Processing query...';
    
    fetch('/api/chat', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        message: query,
        conversation_id: 'admin_test'
      })
    })
      .then(response => response.json())
      .then(data => {
        runButton.disabled = false;
        
        if (data.error) {
          testResult.innerText = `Error: ${data.error}\n${data.details || ''}`;
        } else {
          testResult.innerText = data.response;
        }
      })
      .catch(error => {
        runButton.disabled = false;
        testResult.innerText = `Error: ${error.message}`;
      });
  }
});
</script>
{% endblock %}